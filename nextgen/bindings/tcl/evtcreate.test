#
#  Tests for the spectcl::evtcreate command.
#

package require tcltest
load    .libs/libSpecTclExperiment.so

namespace import ::tcltest::*

#
# much of the setup/cleanup is standard...
# Create an experiment database, and put run 1 in it.
#
proc setup {} {
    set tmpdir  [makeDirectory databases]
    set expfile [file join $tmpdir exp.db]
    set evtfile [file join $tmpdir evt.db]

    set exphandle [::spectcl::expcreate $expfile]
    ::spectcl::run create $exphandle 1 {This is a test title}

    return [list $exphandle $expfile $evtfile]

}

proc cleanup {exphandle expfile evtfile} {
    ::spectcl::expclose $exphandle

    catch {file delete $expfile}
    catch {file delete $evtfile}

}

#---------------------------- The tests ----------------------------

test fail_1 {No experiment handle} \
    -body {
	catch {::spectcl::evtcreate}
    } -result 1

test fail_2 {Invalid experiment handle} \
    -body {
	catch {::spectcl::evtcreate bad-handle}
    } -result 1

test fail_3 {Missing run number.} \
    -setup {
	set setupList [setup]
	set exphandle [lindex $setupList 0]
	set expfile   [lindex $setupList 1]
	set evtfile   [lindex $setupList 2]
    } \
    -cleanup {
	cleanup $exphandle $expfile $evtfile
    } \
    -body {
	catch {::spectcl::evtcreate $exphandle}
    } -result 1

test fail_4 {missing event database filename} \
    -setup {
	set setupList [setup]
	set exphandle [lindex $setupList 0]
	set expfile   [lindex $setupList 1]
	set evtfile   [lindex $setupList 2]
    } \
    -cleanup {
	cleanup $exphandle $expfile $evtfile
    } \
    -body {
	catch {::spectcl::evtcreate $exphandle 1}
    } -result 1   
test fail_5 {bad run number} \
    -setup {
	set setupList [setup]
	set exphandle [lindex $setupList 0]
	set expfile   [lindex $setupList 1]
	set evtfile   [lindex $setupList 2]
    } \
    -cleanup {
	cleanup $exphandle $expfile $evtfile
    } \
    -body {
	catch {::spectcl::evtcreate $exphandle 2 $evtfile}
    } -result 1

test fail_6 {unwritable event database file} \
    -setup {
	set setupList [setup]
	set exphandle [lindex $setupList 0]
	set expfile   [lindex $setupList 1]
	set evtfile   [lindex $setupList 2]
    } \
    -cleanup {
	cleanup $exphandle $expfile $evtfile
    } \
    -body {
	catch {::spectcl::evtcreate $exphandle 1 
	    [file join this path cannot likely exist.db]}
    } -result 1

test create_ok {should be able to create this file} \
    -setup {
	set setupList [setup]
	set exphandle [lindex $setupList 0]
	set expfile   [lindex $setupList 1]
	set evtfile   [lindex $setupList 2]
    } \
    -cleanup {
	cleanup $exphandle $expfile $evtfile
    } \
    -body {
	set evhandle [::spectcl::evtcreate $exphandle 1 $evtfile]
	set prefix   [string range $evhandle 0 [string length "spectcl"]]
    } \
    -result spectcl_


cleanupTests