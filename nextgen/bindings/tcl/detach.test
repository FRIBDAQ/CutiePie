#
#  Tests for the ::spectcl::detach command
#

package require tcltest
load .libs/libSpecTclExperiment.so

namespace import ::tcltest::*

#
# much of the setup/cleanup is standard...
# Create an experiment database, and put run 1 in it.
#
#
# much of the setup/cleanup is standard...
# Create an experiment database, and put run 1 in it.
#
proc setup {} {
    set tmpdir  [makeDirectory databases]
    set expfile [file join $tmpdir exp.db]
    set evtfile [file join $tmpdir evt.db]

    set exphandle [::spectcl::expcreate $expfile]
    ::spectcl::run create $exphandle 1 {This is a test title}
    set evthandle [::spectcl::evtcreate $exphandle 1 $evtfile]

    return [list $exphandle $expfile $evthandle $evtfile]

}

proc cleanup {exphandle expfile evthandle evtfile} {
    catch {::spectcl::expclose $exphandle}
    catch {::spectcl::evtclose $evthandle}
    
    file delete $expfile
    file delete $evtfile
    set dir [file dirname $expfile]


}

#----------------------------  The tests are here.



test detach-exists {The detach command must exist if it was registered properly} \
    -body {
	info command ::spectcl::detach
    } -result ::spectcl::detach

test detach-needhandle {The detach command must be supplied an experiment database handle} \
    -body {
	catch ::spectcl::detach
    } -result 1

test detach-needknownhandle {The detach command must be supplied a known handle} \
    -body {
	catch {::spectcl::detach junk}
    } -result 1

test detach-needexphandle {The handle passed must be for an experiment database} \
    -setup {
	set info [setup]
	set exphandle [lindex $info 0]
	set expfile   [lindex $info 1]
	set evhandle  [lindex $info 2]
	set evtfile   [lindex $info 3]
    }                         \
    -cleanup {
	cleanup $exphandle $expfile $evhandle $evtfile
    }                          \
    -body {
	catch {::spectcl::detach $evhandle}; # known but not exp.
    } -result 1

test detach-notattached {The handle passed must have an event database attached} \
    -setup {
	set info [setup]
	set exphandle [lindex $info 0]
	set expfile   [lindex $info 1]
	set evhandle  [lindex $info 2]
	set evtfile   [lindex $info 3]
    }                         \
    -cleanup {
	cleanup $exphandle $expfile $evhandle $evtfile
    }  \
    -body {
	catch {::spectcl::detach $exphandle}
    } -result 1
  
test detach-default {Should be able to detach a database attached to the default point} \
    -setup {
	set info [setup]
	set exphandle [lindex $info 0]
	set expfile   [lindex $info 1]
	set evhandle  [lindex $info 2]
	set evtfile   [lindex $info 3]
    }                         \
    -cleanup {
	cleanup $exphandle $expfile $evhandle $evtfile
    }  \
    -body {
	spectcl::attach $exphandle $evtfile
	catch {::spectcl::detach $exphandle}
    } -result 0

test detach-nondefault {Should be able to detach database attached to a non default point} \
    -setup {
	set info [setup]
	set exphandle [lindex $info 0]
	set expfile   [lindex $info 1]
	set evhandle  [lindex $info 2]
	set evtfile   [lindex $info 3]
    }                         \
    -cleanup {
	cleanup $exphandle $expfile $evhandle $evtfile
    }  \
    -body {
	spectcl::attach $exphandle $evtfile otherpoint
	catch {spectcl::detach $exphandle otherpoint}
    } -result 0
	


# Collect results.

cleanupTests