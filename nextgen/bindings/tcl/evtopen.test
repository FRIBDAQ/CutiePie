#
# tests for ::spectcl::evtopen
#
package require tcltest
load .libs/libSpecTclExperiment.so

namespace import ::tcltest::*
#
# much of the setup/cleanup is standard...
# Create an experiment database, and put run 1 in it.
#
proc setup {} {
    set tmpdir  [makeDirectory databases]
    set expfile [file join $tmpdir exp.db]
    set evtfile [file join $tmpdir evt.db]

    set exphandle [::spectcl::expcreate $expfile]
    ::spectcl::run create $exphandle 1 {This is a test title}
    ::spectcl::evtcreate $exphandle 1 $evtfile

    return [list $exphandle $expfile $evtfile]

}

proc cleanup {exphandle expfile evtfile evthandle} {
    ::spectcl::expclose $exphandle
    
    catch {::spectcl::evtclose $evthandle}
    catch {file delete $expfile}
    catch {file delete $evtfile}

}

#------------------ the tests

test fail_1 {Need to supply a database name to open} \
    -body {
	catch {::spectcl::evtopen}
    } \
    -result 1

test fail_2 {Path must be to an existing database file} \
    -body {
	catch {::spectcl::evtopen [file join this file does not exist.db]}
    } -result 1


test fail_3 {Path must be an events database} \
    -setup {
	set setupList [setup]
	set exphandle [lindex $setupList 0]
	set expfile   [lindex $setupList 1]
	set evtfile   [lindex $setupList 2]
	set evthandle [lindex $setupList 3]
    } \
    -cleanup \
    {
	cleanup $exphandle $expfile $evtfile $evthandle
    } \
    -body {
	catch {::spectcl::evtopen $expfile}
    } -result 1
 
test open_ok {Should be able to open the file just fine } \
      -setup {
	set setupList [setup]
	set exphandle [lindex $setupList 0]
	set expfile   [lindex $setupList 1]
	set evtfile   [lindex $setupList 2]
	set evthandle [lindex $setupList 3]
    } \
    -cleanup \
    {
	cleanup $exphandle $expfile $evtfile $evthandle
    } \
    -body {
	set handle [::spectcl::evtopen $evtfile]
	set prefix [string range $handle  0 [string length  spectcl]]
    } \
    -result spectcl_

cleanupTests