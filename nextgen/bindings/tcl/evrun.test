#
#
# Test for spectcl::evrun
#

package require tcltest
load .libs/libSpecTclExperiment.so

namespace import ::tcltest::*

proc setup {} {
    set tmpdir  [makeDirectory databases]
    set expfile [file join $tmpdir exp.db]
    set evtfile [file join $tmpdir evt.db]

    set exphandle [::spectcl::expcreate $expfile]
    ::spectcl::run create $exphandle 1 {This is a test title}
    ::spectcl::evtcreate $exphandle 1 $evtfile
    set evthandle [::spectcl::evtopen $evtfile]

    return [list $exphandle $expfile $evtfile $evthandle]

}

proc cleanup {exphandle expfile evtfile evthandle} {
    ::spectcl::expclose $exphandle


    catch {::spectcl::evtclose $evthandle}
    catch {file delete $expfile}
    catch {file delete $evtfile}

}


#----------------------  The tests

test command_exists {The command must exist} \
    -body {
	info commands spectcl::evrun
    } \
    -result ::spectcl::evrun

test need_handle_arg {The command requires a command handle} \
    -body {
	set a [catch {::spectcl::evrun} msg]
    } -result 1

test need_handle {The command requires a handle that is known} \
    -body {
	set a [catch {::spectcl::evrun george} msg]
    } -result 1

test need_evhandle {The command requires a handle to an event database } \
    -setup {
	set info [setup]
	set exphandle [lindex $info 0]
	set expfile   [lindex $info 1]
	set evtfile   [lindex $info 2]
	set evthandle [lindex $info 3]
    } \
    -cleanup {
	cleanup $exphandle $expfile $evtfile $evthandle
    } \
    -body {
	catch {::spectcl::evrun $exphandle} msg
    } -result 1

test correct {The command must return the correct run number} \
    -setup {
	set info [setup]
	set exphandle [lindex $info 0]
	set expfile   [lindex $info 1]
	set evtfile   [lindex $info 2]
	set evthandle [lindex $info 3]
    } \
    -cleanup {
	cleanup $exphandle $expfile $evtfile $evthandle
    } \
    -body {
	::spectcl::evrun $evthandle
    } -result 1
#---------------------- Reporting results.

cleanupTests