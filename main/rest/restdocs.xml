<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
                      "file:///usr/share/xml/docbook/schema/dtd/4.5/docbookx.dtd
"
>
<book>
    <bookinfo>
      <title>SpecTcl REST plugin</title>
      <author><firstname>Ron</firstname><surname>Fox</surname></author>
      <revhistory>
          <revision>
             <revnumber>1.0</revnumber>
             <date>May 1, 2015</date>
             <authorinitials>RF</authorinitials>
             <revremark>Original Release</revremark>
          </revision>
      </revhistory>
    </bookinfo>
    <chapter>
        <title>Introduction</title>
        <para>
            This plugin provides a REST-like method to obtain information from
            SpecTcl.  The plugin can be used to build remote control panels,
            web browser based interfaces to SpecTcl and alternative spectrum
            viewers.
        </para>
        <para>
            This document describes
        </para>
        <itemizedlist>
            <listitem><para>
                How to incorporate the plugin into your SpecTcl at run time
                (in the <filename>SpecTclRC.tcl</filename> file).
            </para></listitem>
            <listitem><para>
                How to make requests of the REST interface and what to
                expect in return.
            </para></listitem>
        </itemizedlist>
        <para>
            A few notes are important:
        </para>
        <itemizedlist>
            <listitem><para>
                The REST plugin is stateless, that is it has no concept of a
                client session.
            </para></listitem>
            <listitem><para>
                The REST plugin responses are returned in JavaScript Object Notation
                (JSON) format.  If you
                intend to write a client, this document assumes you are
                familiar with JSON.
            </para></listitem>
            <listitem><para>
                The REST plugin is built on top of the tclhttpd pure Tcl web server.
            </para></listitem>
            
        </itemizedlist>
        <para>
            How you format, issue and obtaint the response to REST operations
            depends on the language you program in.  For example in a shell
            script you can use the <literal>curl</literal> command.
            In Tcl, the rest package and so on.
        </para>
    </chapter>
    <chapter>
        <title>Incorporating the REST plugin</title>
        <para>
            This chapter assumes that the REST plugin has been installed
            in the SpecTcl installation directory tree, or at least is installed
            somewhere in the Tcl package load path (<literal>auto_path</literal>).
            At the NSCL, the REST plugin is normally installed in:
            <filename>$SpecTclHome/TclLibs/rest</filename>.
        </para>
        <para>
            In this chapter we will see Tcl code that you can incorporate
            in your <filename>SpecTclRC.tcl</filename> script.
            This code will:
        </para>
        <itemizedlist>
            <listitem><para>Load the REST plugin</para></listitem>
            <listitem><para>Select a port on which the REST server will listen for client requests</para></listitem>
            <listitem><para>Start the REST server.</para></listitem>
        </itemizedlist>
        <para>
            For SpecTcl 5.3 and later, starting the REST interface is much simpler
            than described in the remainder of this document.  This is because
            The REST
            In SpecTclInit.tcl simply set the <literal>HTTPDPort</literal> variable
            in <filename>SpecTclInit.tcl</filename> to the desired server port.
            Note that:
            <itemizedlist>
                <listitem>
                   <para>
                      Port numbers below 1024 are privileged ports and cannot
                      be used by programs that are not running as <literal>root</literal>
                   </para>
                </listitem>
                <listitem>
                   <para>
                      If the desired port is in use, SpecTcl will search for a
                      nearby unused port.  
                   </para>
                </listitem>
                <listitem>
                   <para>
                      When the REST interface starts,
                      the actual port number selected will be output to the terminal on which
                      SpecTcl was started.
                   </para>
                </listitem>
            </itemizedlist>
        </para>
        <para>
            The remainder of this section only applies to versionf of SpecTcl
            earlier than 5.3.
        </para>
        <para>
            If the REST plugin was installed in the <filename>$SpecTclHome/TclLibs</filename>
            directory tree, SpecTcl will ensure that it is visible to the
            Tcl package auto load path.  If not you will need to make an approprate
            addition to <varname>auto_path</varname>.
        </para>
        <example>
            <title>Incorporating and starting the REST server</title>
            <programlisting>
package require SpecTclHttpdServer          <co id='require' />
set port [::SpecTcl::findFreePort 8000]     <co id='getport' />
startSpecTclHttpdServer $port               <co id='start' />
....
<computeroutput>Starting 8080 charlie.nscl.msu.edu</computeroutput>           <co id='output' />

            </programlisting>
        </example>
        <calloutlist>
            <callout arearefs='require' >
                <para>
                    The <literal>SpecTclHttpdServer</literal> package contains
                    the REST interface.  Since REST is a web-based protocol,
                    the REST plugin is built on top of a Tcl web server called
                    tclhttpd that has custom, active pages that implement the
                    interface.
                </para>
            </callout>
            <callout arearefs='getport'>
                <para>
                    A system can run several instances of SpecTcl.  Each REST
                    server, however must listen for connections on a
                    distinct TCP/IP port.  The package provides a proc
                    <literal>::SpecTcl::findFreePort</literal> that probes
                    for an unused port starting at a base port.
                </para>
                <para>
                    This line locates the first unused port above port number
                    <literal>8000</literal>, and returns that port number.
                    You can display the port number you used at stdout or
                    in a custom user interface so that you know how to
                    point your clients at the server.
                </para>
            </callout>
            <callout arearefs='start'>
                <para>
                    Starts the REST server.  Once this has been done
                    REST requests can be made of the server.
                </para>
            </callout>
            <callout arearefs='output'>
                <para>
                    As the server starts it outputs a few lines of text on
                    Tcl's stdout file (in most cases for SpecTcl this is redirected
                    to the <literal>TkCon</literal> window.
                    As this line shows, one of the bits of output identifies the
                    port and host on which the server is running.
                </para>
            </callout>
        </calloutlist>
    </chapter>
    <chapter>
        <title>REST requests supported.</title>
        <section>
            <title>General Request format</title>
            <para>
                Rest requests are made by performing an httpd GET operation.
                The actual request is a combination of the URL and the query
                parameters added to the end of the URL.  
            </para>
            <para>
                You can think of the URL as being made up of the following components:
            </para>
            <variablelist>
                <varlistentry>
                    <term>Connection information</term>
                    <listitem>
                        <para>
                            This consists of the protocol (<literal>http:</literal>),
                            the name of the host in which SpecTcl is running and
                            the port on which its REST server is oeprating.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>Application name</term>
                    <listitem>
                        <para>
                            The tclhttpd server is extensible and, although this
                            will not be described, you could add additional services
                            to it.  The application name identifies a bundle of
                            services that are logically related (in this
                            case the SpecTcl REST services).
                        </para>
                        <para>
                            The application name is the first element of the
                            URL's path and, for the REST plugin is always
                            <literal>spectcl</literal>
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>Service group</term>
                    <listitem>
                        <para>
                            The services offered by the REST server are grouped
                            in logically related operations.  For example,
                            there is a <literal>spectrum</literal> group
                            which offers operations and queries on spectra.
                        </para>
                        <para>
                            The service group is the path element that immediately
                            follows the application name. The remaining sections
                            of this chapter describe each service group.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>Operation</term>
                    <listitem>
                        <para>
                            Each service group offers a set of operations.
                            For example the
                            <literal>spectrum</literal> service group offers
                            an operation called <literal>list</literal>.
                            This
                            is encoded in the path element of the URL immediately
                            following the service group.  
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>Query parameters</term>
                    <listitem>
                        <para>
                            If you think of each operation as a function in a
                            programming language, you can think of the
                            query parameters as the arguments to that function
                            In a URL, query parameters are introduced with a
                            <literal>?</literal> character and consist of a set
                            of <literal>parameter=value</literal> strings that
                            are separated by the <literal>&amp;</literal> character.
                        </para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <para>
                Suppose for example, you want to list all spectra whose names
                begin with <literal>raw</literal>.
                Assuming that the SpecTcl REST server is running on port 8080 in
                the host charlie.nscl.msu.edu,
                a GET operation on the following URL will return that information:
            </para>
            <informalexample>
                <literallayout>
http://charlie.nscl.msu.edu:8080/spectcl/spectrum/list?pattern=raw*
                </literallayout>
            </informalexample>
            <para>
                Information returned from the REST request is formatted as a
                JavaScript Object Notation (JSON) object.  All of these objects
                have an attribute named <literal>status</literal>.  If the
                value of this attribute is <literal>OK</literal>, the request
                succeeded.  If not the operation failed and the
                <literal>status</literal>
                value is a short reason for the failure.
            </para>
            <para>
                Almost all returned objects also include a
                <literal>detail</literal> attribute.  On failures,
                this can contain more detailed information about the failure.
                For success, this is where data associated with the request
                is returned.  The contents of the <literal>detail</literal>
                attribute will be described with the description of each REST
                request.
            </para>
            
        </section>
        <section>
            <title>Parameter requests</title>
            <para>
                The <literal>parameter</literal> service group provides
                services related to SpecTcl parameters and tree parameters.
                The base URL for this service group is like:
            </para>
            <informalexample>
                <programlisting>
http://<replaceable>host.name:port-num</replaceable>/spectcl/parameter
                </programlisting>

            </informalexample>
            <para>
                The remainder of this section describes the operations provided by
                this service goup.
            </para>
            <section>
                <title>list</title>
                <para>
                    Lists the SpecTcl raw parameters and their properties.
                    If the parameter is also defined as a tree parameter
                    the tree parameter properties are supplied.
                </para>
                <para>
                    The <literal>filter</literal> query parameter
                    accepts a glob pattern.  If it is not provided it defaults
                    to <literal>*</literal> which matches all parametrs.
                </para>
                <para>
                    On success, the <literal>detail</literal> attribute
                    of the returned JSON object is an array of objects,
                    one for each parameter whose name matches the
                    <literal>filter</literal>
                </para>
                <para>
                    Each object in the array has the following attributes:
                </para>
                <variablelist>
                    <varlistentry>
                        <term><literal>name</literal></term>
                        <listitem>
                            <para>
                                The parameter name
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>id</literal></term>
                        <listitem>
                            <para>
                                The parameter id.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>bins</literal> (tree parameters only)</term>
                        <listitem>
                            <para>
                                Number of suggested bins an axis of this parameter
                                should have.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>low</literal> (tree parameters only)</term>
                        <listitem>
                            <para>
                                Recommended low limit for an axis of this parameter.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>hi</literal> (tree parameters only)</term>
                        <listitem>
                            <para>
                                Recommended high limit for an axis of thsi parameter.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>units</literal> (tree parameters only)</term>
                        <listitem>
                            <para>
                                Units of measure this parameter is in.
                            </para>
                        </listitem>
                    </varlistentry>
                    
                </variablelist>
                
            </section>
            <section>
                <title>edit</title>
                <para>
                    Modifies the properites of a tree parameter.  This
                    operation has the following query parameters:
                </para>
                <variablelist>
                    <varlistentry>
                        <term><literal>name</literal></term>
                        <listitem>
                            <para>
                                Name of the tree parameter.  The value of this
                                parameter defaults to empty which won't usually
                                match a tree parameter.  The value of
                                <literal>name</literal> must be the name
                                of a currently defined tree parameter.
                            </para>
                            <para>
                                If the name is not a tree parameter
                                a <literal>status</literal> of
                                <literal>not found</literal> is returned
                                with a <literal>detail</literal> that is
                                the value of the <literal>name</literal>
                                parameter.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>bins</literal></term>
                        <listitem>
                            <para>
                                If supplied the tree parameter's bins property
                                will be modified to the value of this parameter.
                                If not supplied, that attribute will not be changed.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>low</literal></term>
                        <listitem>
                            <para>
                                If supplied the tree parameter's low limit property
                                will be modified to the value of ths parameter.
                                If not supplied, that property will not be modified.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>high</literal></term>
                        <listitem>
                            <para>
                                If supplied, the tree parameter's high limit property
                                will be modified to the value of this parameter.
                                If not supplied, that property will remain unchanged.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>units</literal></term>
                        <listitem>
                            <para>
                                If supplied, the tree parameter's units property will
                                be modified to the value of this parameter.  If not
                                supplied, that property will remain unchanged.
                            </para>
                        </listitem>
                    </varlistentry>
                    
                </variablelist>
                <para>
                    On success the return has a <literal>status</literal> of
                    <literal>Ok</literal> and an empty <literal>detail</literal>.
                    Several errors are possible and detected:
                    <literal>not found</literal> indicates the tree parameter
                    was not found. <literal>command failed</literal> indicates
                    that a <command>treeparameter</command> failed.
                </para>
            </section>
            <section>
                <title>promote</title>
                <para>
                    This operation promotes a simple, raw SpecTcl prameter to
                    a tree parameter.  The difference between a parameter and
                    a tree parameter from the point of view of the REST
                    interface is that tree parameters have additional properties
                    that can assist you in choosing good axis limits an binning
                    when creating spectra.
                </para>
                <para>
                    The following query parameters are recognized by
                    the <literal>promote</literal> operation.  Note that
                    most of them are mandator and an error is returned if
                    mandatory parameters are not supplied.
                </para>
                <variablelist>
                    <varlistentry>
                        <term><literal>name</literal> (mandatory)</term>
                        <listitem>
                            <para>
                                Name of the parameter.   This parameter must
                                already exist but must also not be a tree parameter.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>low</literal> (mandatory)</term>
                        <listitem>
                            <para>
                                Sets the low limit property of the parameter.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>high</literal> (mandatory)</term>
                        <listitem>
                            <para>
                                Sets the high limit property of the parameter
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>bins</literal> (mandatory)</term>
                        <listitem>
                            <para>
                                Sets the bins property of the parameter.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>units</literal> (optional)</term>
                        <listitem>
                            <para>
                                Sets the units of measure of the parameter.
                            </para>
                        </listitem>
                    </varlistentry>
                    
                </variablelist>
                <para>
                    On success, the <literal>detail</literal> attribute
                    of the returned object is empty. Several error returns
                    are possible (<literal>status</literal> not <literal>Ok</literal>):
                </para>
                <formalpara>
                    <title><literal>missing parameter</literal></title>
                    <para>
                        If one or more of the mandatory parameters is not
                        present.  In that case the <literal>detail</literal>
                        field is the name of one of the missing parameters.
                    </para>
                </formalpara>
                <formalpara>
                    <title><literal>not found</literal></title>
                    <para>
                        If the <literal>name</literal> parameter value
                        does not correspond to an existing parameter.
                        The <literal>detail</literal> is the name of the
                        parameter.
                    </para>
                </formalpara>
                <formalpara>
                    <title>already treeparameter</title>
                    <para>
                        If the parameter named is already a tree parameter.
                        The <literal>detail</literal> is the name of the
                        parameter.
                    </para>
                </formalpara>
                <formalpara>
                    <title>command failed</title>
                    <para>
                        If the <command>treeparameter -create</command>
                        command failed.  The <literal>detail</literal>
                        field is the error message emitted by the
                        failing command.
                    </para>
                </formalpara>
            </section>
        </section>
        <section>
            <title>spectrum requests</title>
            <para>
                The <literal>spectrum</literal> service group provides
                operations that revolve around spectra in SpecTcl.
                This service group allows you to request information
                about spectra, create and delete spectra.
            </para>
            <para>
                The base URL for this service group is
            </para>
            <informalexample>
                <programlisting>
http://<replaceable>host.name:port-num</replaceable>/spectcl/spectrum                    
                </programlisting>
            </informalexample>
            <section>
                <title>list</title>
                <para>
                    Produces information about the spectra whose
                    names match a pattern with glob wildcards characters.
                    The <literal>filter</literal> optional parameter
                    provides the value of this pattern.  If not
                    supplied it defaults to <literal>*</literal>
                    which matches all spectra.
                </para>
                <para>
                    The <literal>detail</literal> attribute of the
                    returned object is an array of objects, one object
                    for each matching spectrum.  Each of these objects
                    has the following fields that, taken together, describe
                    the spectrum:
                </para>
                <variablelist>
                    <varlistentry>
                        <term><literal>name</literal></term>
                        <listitem>
                            <para>
                                The spectrum name.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>type</literal></term>
                        <listitem>
                            <para>
                                The SpecTcl spectrum type code.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>params</literal></term>
                        <listitem>
                            <para>
                                The SpecTcl spectrum parameter definitions.
                                This is provided as an array of strings.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>axes</literal></term>
                        <listitem>
                            <para>
                                This is an array of objects that
                                describe the SpecTcl axes.  Each object
                                has the attributes <literal>low</literal> for
                                the axis low limit, <literal>high</literal>
                                for the axis high limit and <literal>bins</literal>
                                for the number of bins on that axis.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>chantype</literal></term>
                        <listitem>
                            <para>
                                The SpecTcl channel type code (e.g. <literal>long</literal>).
                            </para>
                        </listitem>
                    </varlistentry>
                    
                </variablelist>
            </section>
            <section>
                <title>delete</title>
                <para>
                    Deletes a single spectrum.  The <literal>name</literal>
                    parameter provides the name of the spectrum to delete.
                </para>
                <para>
                    On success the <literal>detail</literal> field is empty.
                    The non success returns include:
                </para>
                <formalpara>
                    <title>missing parameter</title>
                    <para>
                        The <literal>name</literal> parameter was not supplied.
                    </para>
                </formalpara>
                <formalpara>
                    <title>not found</title>
                    <para>
                        There was no spectrum with the name provided.
                    </para>
                </formalpara>
                <formalpara>
                    <title>command failed</title>
                    <para>
                        The <command>spectrum -delete</command> command failed.
                        <literal>detail</literal> contains the error message returned
                        by the command.
                    </para>
                </formalpara>
            </section>
            <section>
                <title>create</title>
                <para>
                    Creates a new spectrum.  The  spectrumto be created is
                    defined by the query parameters, most of which are mandatory:
                </para>
                <variablelist>
                    <varlistentry>
                        <term><literal>name</literal> (mandatory)</term>
                        <listitem>
                            <para>
                                The name of the new spectrum.  This must not
                                be the name of an existing spectrum.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>type</literal> (mandatory)</term>
                        <listitem>
                            <para>
                                The spectrum type code e.g. <literal>1</literal>
                                for a 1-d spectrum.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>parameters</literal> (mandatory)</term>
                        <listitem>
                            <para>
                                The parameters expressed as a space separated list. 
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>axes</literal> (mandatory)</term>
                        <listitem>
                            <para>
                                The axis specifications.  This is a space separated
                                list of SpecTcl axis specifications e.g.:
                                <literal>{0 1023 100} {0 1023 200}</literal>.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>chantype</literal> (optional)</term>
                        <listitem>
                            <para>
                                The spectrum channel type, defaults to
                                <literal>long</literal>.
                            </para>
                        </listitem>
                    </varlistentry>
                </variablelist>
                <para>
                        On success, the <literal>detail</literal> field of the
                        returned objexct is empty.  Several types of failures are
                        directly tested for:
                </para>
                <variablelist>
                    <varlistentry>
                        <term><literal>missing parameter</literal></term>
                        <listitem>
                            <para>
                                A mandatory parameter was not supplied.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>command failed</term>
                        <listitem>
                            <para>
                                The <command>spectrum -create</command>
                                command failed.  <literal>detail</literal>
                                is the error message from that command.
                            </para>
                        </listitem>
                    </varlistentry>
                    
                </variablelist>
            </section>
            <section>
                <title>clear</title>
                <para>
                    Clears the counts in a set of spectra. The
                    <literal>pattern</literal> parameter supplies
                    a glob patternt hat the cleared spectra match.
                    <literal>pattern</literal> defaults to <literal>*</literal>
                    which clears all spectra
                </para>
                <para>
                    This operation has no failure returns.  The worst thing
                    it can do is to clear nothing (no matching patter).
                    The <literal>detail</literal> attribute of the returned
                    objetct is also empty
                </para>
                
            </section>
            <section>
                <title>contents</title>
                <para>
                    Returns the contents of the a spectrum.  The contents of a
                    spectrum are sufficient to reconstruct the spectrum channels
                    and overflow statistics.
                    The only parameter is the mandatory <literal>name</literal>
                    parameter which is the name of the spectrum to return.
                </para>
                <para>
                    There are some significant differences in what can be returned.
                    These differences depend on the underlyng spectrum type
                    (1 or 2d) and the version of SpecTcl the REST server is running
                    on (4.0 or earlier). 
                </para>
                <para>
                    Prior to SpecTcl 4.0, spectra did not maintain over/undeflow
                    statistics.  The REST interface for those version of SpecTcl
                    produced an array of channel objects for the channels with
                    non-zero counts as the value of the <literal>detail</literal>
                    attribute:
                </para>
                <para>
                    Channel objects have the following attributes:
                </para>
                <variablelist>
                    <varlistentry>
                        <term><literal>x</literal></term>
                        <listitem>
                            <para>
                                The X channel number.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>y</literal> (2-d spectra only)</term>
                        <listitem>
                            <para>
                                The Y channel number.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>v</literal></term>
                        <listitem>
                            <para>
                                The number of counts at that channel.
                            </para>
                        </listitem>
                    </varlistentry>
                    
                </variablelist>
                <para>
                    Beginning with SpecTcl version 4.0, the <literal>detail</literal>
                    attribute became an object with the attributes
                    <literal>channels</literal> and <literal>statistics</literal>.
                    The <literal>channels</literal> attribute contains the array
                    of channel objects and the <literal>statistics</literal> attribute
                    contains an object that describes the over/underflow statistics
                    for the spectrum.  Its attributes are:
                </para>
                <variablelist>
                    <varlistentry>
                        <term><literal>xunderflow</literal></term>
                        <listitem>
                            <para>
                                The number of times an X parameter value was below
                                the X axis low limit.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>yunderflow</literal> (2-d only)</term>
                        <listitem>
                            <para>
                                The numer of times a Y parameter value was below the
                                Y axis low limit.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>xoverflow</literal></term>
                        <listitem>
                            <para>
                                The number of times an x parameter was above the
                                X axis high limit.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>yoverflow</literal> (2-d only)</term>
                        <listitem>
                            <para>
                                The number of times a Y parameter value was above
                                the Y axis high limit.
                            </para>
                        </listitem>
                    </varlistentry>
                    
                    
                </variablelist>
                <para>
                    Two optimizations are performed.  Channel objects are only
                    present for non-zerof channels.  2d spectra may be emitted with
                    the <literal>Content-encoding deflate</literal>.  In that
                    case the special header <literal>Uncompressed-Length</literal>
                    provides the number of bytes required to hold the uncompressed
                    JSON after defation.
                </para>
            </section>
            
        </section>
        <section>
            <title>gate requests</title>
            <para>
                This service group provides operations on Gates. The base URI of
                this service group is:
            </para>
            <informalexample>
                <cmdsynopsis><command>
http://<replaceable>host.name:port-num</replaceable>/spectcl/gate                    
                </command></cmdsynopsis>
            </informalexample>
        </section>
        <section>
            <title>list</title>
            <para>
                List the definitions of gates whose names match a pattern
                with glob wildcards.  The <literal>pattern</literal>
                parameter provides the pattern.  If <literal>pattern</literal>
                is not specified, it defaults to <literal>*</literal>
                which matches all gate names.
            </para>
            <para>
                The <literal>detail</literal> field of the reply is
                an array of objects.  Each objects describes a
                gate who's name matches the <literal>pattern</literal>.
                The actual shape of the objects can vary quite a bit depending
                on the gate type.
            </para>
            <para>
                All gate types have the following attributes in their objects:
            </para>
            <variablelist>
                <varlistentry>
                    <term><literal>name</literal></term>
                    <listitem>
                        <para>
                            Name of the gate.
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><literal>type</literal></term>
                    <listitem>
                        <para>
                            Gate type code.
                        </para>
                    </listitem>
                </varlistentry>
                
            </variablelist>
            <para>
                The remaining attributes depend on the value of
                the <literal>type</literal> attribute.
            </para>
            <section>
                <title>Compound gates (<literal>+ * -</literal>)</title>
                <para>
                    Compound gates are gates that are formed from other
                    gates.  The gates a compound gate is formed from are
                    called <firstterm>component gates</firstterm>.
                    The <literal>+</literal> gate is true
                    when any of the components is true.  <literal>+</literal>
                    means <literal>Or</literal>.
                    The <literal>*</literal> get by contrast is an
                    <literal>And</literal> gate; it reuires all of its
                    component gates to be true.  Finally the
                    <literal>-</literal>, or <literal>Not</literal>
                    gate has only a single component gate and is true
                    when that gate is false (logical complement).
                </para>
                <para>
                    The remaining attribute of a compound gate is
                    called <literal>gates</literal> and consists of
                    an array of gate name strings.
                </para>
            </section>
            <section>
                <title>Slice (<literal>s</literal>)</title>
                <para>
                    Slice gates check a single parameter against
                    a low and high limit and are true for events
                    when the parameter is inside the limits.
                    The <literal>parameters</literal> attribute
                    is an array that contains the name of the single parameter.
                    The plural and array are used so that we can have some
                    uniformity for gates that depend on parameters.
                </para>
                <para>
                    The <literal>low</literal> and
                    <literal>high</literal> attributes are the low
                    and high limits of the slice.
                </para>
                <para>
                    Below is the JSON that might be returned for a slice gate
                    named <literal>cut</literal>:
                </para>
                <informalexample>
                    <programlisting>
{
    "status" : "OK",
    "detail" : [{
        "name"       : "cut",
        "type"       : "s",
        "parameters" : ["event.raw.00"],
        "low"        : 29.710001,
        "high"       : 52.480003
    }]
}                        
                    </programlisting>
                </informalexample>
                <para>
                    Note that even though only one gate has matched
                    <literal>detail</literal> is an array.  Similarl
                    note that <literal>parameters</literal> is an array.
                </para>
            </section>
            <section>
                <title>Gamma slice (<literal>gs</literal>) </title>
                <para>
                    A gamma slice gate is much like a slice gate.  Gamma slice gates,
                    however have several parameters and are true whenever one of those
                    parameters is in the gate.  When used as gates they are very much
                    like an or of a bunch of identical slice gates, one on each parameter.
                    Their value, however, is when used as folds in a gamma spectrum.
                </para>
                <para>
                    The format of this gate is identical to that of a slice gate, however
                    there really is more than one parameter in the
                    <literal>parameters</literal> array for example:
                </para>
                <informalexample>
                    <programlisting>
{
    "status" : "OK",
    "detail" : [{
        "name"       : "gs",
        "type"       : "gs",
        "parameters" : ["event.raw.00","event.raw.01","event.raw.02","event.raw.03"],
        "low"        : 194.369995,
        "high"       : 368.279999
    }]
}                        
                    </programlisting>
                </informalexample>
            </section>
            <section>
                <title>Simple 2-d gates (<literal>b c</literal>)</title>
                <para>
                    Simple 2-d gates are <firstterm>band</firstterm>
                    and <firstterm>contour</firstterm> gates.  These gates
                    are defined on two parameters and have an array of points
                    that define an area in the two dimensional space defined
                    by those parameters.
                </para>
                <para>
                    The <literal>parameters</literal> field contains the name
                    of the x followed by the name of the y parameter.
                    The the <literal>points</literal> attribute contains an array
                    of objects that contain <literal>x</literal> and <literal>y</literal>
                    attributes:
                </para>
                <informalexample>
                    <programlisting>
{
    "status" : "OK",
    "detail" : [{
        "name"       : "c",
        "type"       : "c",
        "parameters" : ["event.raw.00","event.raw.01"],
        "points"     : [{
            "x" : 182.821289,
            "y" : 280.725586
        },{
            "x" : 512.499023,
            "y" : 180.823242
        },{
            "x" : 675.339844,
            "y" : 340.666992
        },{
            "x" : 665.349609,
            "y" : 514.497070
        }]
    }]
}                        
                    </programlisting>
                </informalexample>
                <para>
                    The name of this gate is <literal>c</literal> and it is
                    a contour (<literal>type</literal> = "c").  If this were a
                    band, the <literal>type</literal> would be "b".  The only
                    difference between a band an a contour is what the points mean.
                    In a contour, the points define a closed figure and the gate is
                    true when the x/y parameters are both present and inside the figure.
                    For a band, the gate is true when both x/y parameters are present
                    and the point is below the figure defined by the points.
                </para>
                <para>
                    Contours have an implied last point that is the same as the first point.
                    That is the last point in the contour connects to the first point to
                    close the contour.
                </para>
            </section>
            <section>
                <title>Gamma bands and contours (<literal>gb gc</literal></title>
                <para>
                    These gates are like bands and contours however they have more than
                    two parameters.  All combinations are tried against the gate and if
                    any are true the gate is true.  Once more these are more valuable
                    when used to define a fold.
                </para>
                <para>
                    The JSON is pretty much the same as for bands and contours, however
                    there will can be more than two <literal>parameters</literal>:
                </para>
                <informalexample>
                    <programlisting>
{
    "status" : "OK",
    "detail" : [{
        "name"       : "gammacont",
        "type"       : "gc",
        "parameters" : ["event.raw.00","event.raw.01","event.raw.02","event.raw.03","event.raw.04"],
        "points"     : [{
            "x" : 122.879997,
            "y" : 409.600006
        },{
            "x" : 440.320007,
            "y" : 204.800003
        },{
            "x" : 860.159973,
            "y" : 450.559998
        },{
            "x" : 696.320007,
            "y" : 665.599976
        }]
    }]
}
                    </programlisting>
                </informalexample>
            </section>
            <section>
                <title>Bit mask gates (<literal>em am nm</literal>)</title>
                <para>
                    These gates are defined on a single parameter that is assumed
                    to contain integer.  The <literal>em</literal> (equal mask)
                    is true when the parameter is equal to the mask.
                    The <literal>am</literal> (and mask) is true when the
                    parameter, bit-wised anded with the mask is equal to th emask
                    (all the bits set in the mask are set in the parameter).
                    The <literal>nm</literal> is true if the parameter bit-wise anded
                    with the bit-wise complemnt of the mask is equal to the mask.
                </para>
                <para>
                    In addition to the <literal>parameters</literal>
                    attribute the description contains <literal>value</literal>
                    which is the value of the mask:
                </para>
                <informalexample>
                    <programlisting>
  {
    "status" : "OK",
    "detail" : [{
        "name"       : "mask",
        "type"       : "em",
        "parameters" : ["event.raw.00"],
        "value"      : 0X1234
    }]
}                      
                    </programlisting>
                </informalexample>
            </section>
        </section>
        <section>
            <title>delete</title>
            <para>
                Deletes a gate named by the <literal>name</literal>
                parameter.  The <literal>name</literal> parameter
                is required and must name an existing gate.
            </para>
            <para>
                The <literal>detail</literal> attribute of the
                returned object is empty.  Note that in SpecTcl,
                gates are never actualyl deleted, the are turned into
                gates that are always <literal>false</literal>
                instead.  This allows you to know and reason about the
                behavior of gates that depend on the deleted gates.
            </para>
        </section>
        <section>
            <title>edit</title>
            <para>
                This operation creates or re-defines (edits) an existing gate.
                The <literal>name</literal> parameter specifies the name of the
                gate.  If the gate does not exist it will be created.
                Gates can not only be edited to change their points. Any aspect
                of a gate can be modified (except the name of the gate).
            </para>
            <para>
                The <literal>type</literal> parameter determines the new
                type of the gate.
                The remaining parameters depend on the value of this type.
            </para>
            <section>
                <title>Compound gates (<literal>* + -</literal>)</title>
                <para>
                    These gates only require a <literal>gate</literal>
                    parameter whose value is a Tcl list of component gates.
                </para>
            </section>
            <section>
                <title>Constant gates (<literal>T F</literal>)</title>
                <para>
                    These are gates that are either always TRUE or always
                    FALSE.  They are normally used as placeholders.  For
                    example SpecTcl itself replaces a deleted gate with a
                    FALSE gate in order to ensure that any dependent
                    gates will continue to function in a predictable manner.
                </para>
                <para>
                    These gates do not require any additional parameters.
                </para>
            </section>
            <section>
                <title>Bands and Contours (<literal>b c</literal>)</title>
                <para>
                    These gates need both an <literal>xparameter</literal> and
                    a <literal>yparameter</literal> value to describe the X and
                    Y parameters to check against the definition.  In addtion, these
                    gates need several instances of <literal>xcoord</literal>
                    parameters (x position of gate points) and
                    <literal>ycoord</literal> parameters (y position of gate points).
                </para>
                <para>
                    If there are differing number of x and y coordinates
                    (you really should avoid that), only those points for which
                    the x/y coordinates were both specified will be used.
                    A band must have a minimum of two points while a contour
                    requires at least three points.  For contours, there is an
                    additional implied line segment joining the last and first points
                    to close the figure.
                </para>
            </section>
            <section>
                <title>Bit mask gates (<literal>em am nm</literal>)</title>
                <para>
                    Bit mask gates require a <literal>parameter</literal> and
                    a <literal>value</literal> parameter.   The
                    <literal>parameter</literal> indicates which event
                    parameter will be checked againts the <literal>value</literal>
                    which is a bitmask.
                </para>
            </section>
            <section>
                <title>Slice gates (<literal>s</literal>)</title>
                <para>
                    Slice gates require three query parameters:
                </para>
                <variablelist>
                    <varlistentry>
                        <term><literal>parameter</literal></term>
                        <listitem>
                            <para>
                                Provides the name of the parameter checked
                                against the slice.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>low</literal></term>
                        <listitem>
                            <para>
                                Low limit of the slice.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>high</literal></term>
                        <listitem>
                            <para>
                                High limit of the slice.
                            </para>
                        </listitem>
                    </varlistentry>
                    
                </variablelist>
                <para>
                    Note that if <literal>low</literal> is larger
                    than <literal>high</literal>, SpecTcl will
                    reverse these parameters to create a sensible gate.
                </para>
            </section>
            <section>
                <title>Gamma 2d gates (<literal>gb gc</literal></title>
                <para>
                    These neewd the follwoing additional parametrs:
                </para>
                <variablelist>
                    <varlistentry>
                        <term><literal>parametrer</literal></term>
                        <listitem>
                            <para>
                                Must appear t least twice and can appear
                                several times. Each appearance adds a
                                parameter to the list of parameters
                                the gate will be checked against.
                            </para>
                            <para>
                                Gamma gates are true for each pair of parameters
                                that are in the gate.  They are more useful
                                as folds than as actual gates.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>xcoord</literal></term>
                        <listitem>
                            <para>
                                Provides an X coordinate for a gate point.
                                These are orderd and will be matched up with
                                <literal>ycoord</literal> values (see below).
                                A band requires at least two of these and a
                                contour at least three.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>ycoord</literal></term>
                        <listitem>
                            <para>
                                Provides the y coordinate for a gate point.
                                These are ordered and will be matched up with
                                corresponding <literal>xcoord</literal> values.
                                If there is an excess of either <literal>xcoord</literal>
                                or <literal>ycoord</literal> values, the excess
                                is discarded.
                            </para>
                            <para>
                                A band requires at least two points while a contour
                                requires at least three.
                            </para>
                        </listitem>
                    </varlistentry>
                    
                </variablelist>
            </section>
            <section>
                <title>Gamma slice (<literal>gs</literal>)</title>
                <para>
                    As for a slice gate a <literal>high</literal> and
                    <literal>low</literal> parameter are required to set
                    the limits for the gate.  For Gammma slice gates, however
                    you can have more than one <literal>parameter</literal>
                    query option.  Each <literal>parameter</literal> adds
                    another parameter to the list of parameters checked
                    against the gate.
                </para>
                <para>
                    Gamma slice gates are true if any of the parameters
                    are within the slice.  As such, they are more useful
                    as folds where they can cut down the set of parameters
                    that can actually increment spectra.
                </para>
            </section>
        </section>
        <section>
            <title>Gate Applications.</title>
            <para>
                The <literal>/spectcl/apply</literal> set of URLs provide access
                to the SpecTcl <command>apply</command> command.  This set of
                URLs can
            </para>
            <itemizedlist>
                <listitem>
                   <para>
                      Apply a gate to a spectrum.  Applying a gate to a spectrum
                      only allows that spectrum to be incremented for events
                      that make that gate <literal>true</literal>
                   </para>
                </listitem>
                <listitem>
                   <para>
                      List the gate applied to a spectrum.  Note that to make the
                      SpecTcl logic regular, all Spectra actually have exactly
                      one gate applied to them.  Always.  
                   </para>
                   <para>
                      When Spectra are initially created, the gate
                      <literal>-TRUE-</literal> is applied which is a True
                      gate.  True gates are true regardless of the event contents.
                   </para>
                </listitem>
            </itemizedlist>
            <section>
                <title>Applying a gate to a spectrum.</title>
                <para>
                    To apply a gate to a spectrum the URI of the form:
                </para>
                <informalexample>
                <cmdsynopsis><command>
http://<replaceable>host.name:port-num</replaceable>/spectcl/apply/apply               
                </command></cmdsynopsis>
                </informalexample>
                <para>
                    Should be used.  This URI has two required query parameters:
                </para>
                <variablelist>
                    <varlistentry>
                       <term>gate</term>
                       <listitem>
                           <para>
                            The name of the gate to apply to the spectrum.
                           </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                       <term>spectrum</term>
                       <listitem>
                           <para>
                            The name of the spectrum to which the gate is applied.
                           </para>
                        </listitem>
                    </varlistentry>
                </variablelist>
                <para>
                    The response from the server, on success, is
                    
                </para>
                <informalexample>
                    <programlisting>
{
    "status" : "OK",
    "detail" : ""
}          
                    </programlisting>
                </informalexample>
                <para>
                    Any other value for the status attribute is an error return
                    message and the detail attribute furthere clarifies the
                    error.
                </para>            
            </section>
            <section>
                <title>Listing gate applications</title>
                <para>
                    To list the gates applied to a spectrum  a URI of the form.
                </para>
                <informalexample>
                    <cmdsynopsis><command>
http://<replaceable>host.name:port-num</replaceable>/spectcl/apply/list                          
                    </command></cmdsynopsis>
                </informalexample>
                <para>
                    Should be used.  This URI accepts a single optional
                    query parameter <literal>pattern</literal> whose value is a
                    glob pattern string that filters the output by spectrum
                    names that match that pattern.  If this parameter
                    is omitted it defaults to <literal>*</literal> which
                    lists the gates applied to all spectra.
                </para>
                <para>
                    The result is a JSON object with attributes
                    <literal>status</literal> and <literal>detail</literal>.
                    The <literal>status</literal> attribute value will always
                    be a the string <literal>OK</literal> as this URI produces
                    no errors.
                </para>
                <para>
                    The <literal>detail</literal> attribute value is an array
                    of JSON objects.  Each element of the array describes
                    a single gate application for a matching spectrum.
                    The attributes of these objects are:
                </para>
                <variablelist>
                    <varlistentry>
                       <term><literal>spectrum</literal></term>
                       <listitem>
                           <para>
                            The value of this attribute is the name of a
                            spectrum.
                           </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                       <term><literal>gate</literal></term>
                       <listitem>
                           <para>
                            The value of this attribute is the name of the
                            gate applied to this spectrum.  Note again,
                            that every spectrum has a gate applied to it, however
                            some spectra may have a <literal>true</literal>
                            gate applied to themto effectively un gate them.
                           </para>
                        </listitem>
                    </varlistentry>
                </variablelist>
                <para>
                    Sample return value:
                </para>
                <informalexample>
                    <programlisting>
{
    "status" : "OK",
    "detail" : [{
        "name" : "some.spectrum",
        "gate" : "some.gate"
    },
    {
        "name" : "ungated.spectrum",
        "gate" : "-TRUE-"
    }
    ]
}      
                    </programlisting>
                </informalexample>
            </section>
        </section>
        <section>
            <title>Attaching data sources (New in 5.5)</title>
            <para>
                The SpecTcl <command>attach</command> command can be
                accessed using the <literal>/spectcl/attach</literal> URL
                domain.
            </para>
            <informalexample>
                <cmdsynopsis><command>
http://host:port/spectcl/apply/apply?type=srctype&amp;source=src<optional>&amp;size=bsize&amp;format=fmt</optional>
                </command></cmdsynopsis>
            </informalexample>
            <para>
                Attaches a new data source to SpecTcl.  Query parameters are:
            </para>
            <variablelist>
                <varlistentry>
                   <term><literal>type</literal></term>
                   <listitem>
                       <para>
                        The type of data source. Currently this is
                        one of <literal>file</literal> to read data from a
                        file or <literal>pipe</literal> to read data from a
                        program on the other end of a pipe. 
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>source</literal></term>
                   <listitem>
                       <para>
                        The source string expected by the
                        <command>attach</command> command for the specified
                        source type.  For <literal>file</literal> data sources,
                        this is just the path to the file to read. Note that
                        since SpecTcl's directory is not known it's recommended
                        the full path be provided.  For <literal>pipe</literal>
                        data sources this is the full command string.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>size</literal></term>
                   <listitem>
                       <para>
                        Optional query parameter that, if supplied, sets the
                        blocking factor for reads from the data source.
                        This defaults to <literal>8192</literal>
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>format</literal></term>
                   <listitem>
                       <para>
                        Optional query parameter that, if supplied, sets
                        the data format.  Acceptable values are:
                       </para>
                       <variablelist>
                        <varlistentry>
                           <term><literal>ring</literal></term>
                           <listitem>
                               <para>
                                The data are ring items, see, however
                                the <literal>/spectcl/ringformat</literal>
                                domain to select the version of ring items.
                                This is the default value
                               </para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                           <term><literal>nscl</literal></term>
                           <listitem>
                               <para>
                                Data are fixed length
                                8192 byte buffers from NSCLDAQ
                                before version 10.0
                               </para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                           <term><literal>jumbo</literal></term>
                           <listitem>
                               <para>
                                Data are fixed length buffers longer than
                                128K bytes from NSCLDAQ prior to version 10.0.
                                This was used for some MoNA experiments
                                that took trace data and therefore needed
                                longer buffers.  The difference is an extension
                                to the 16 bit used blocksize (in 16 bit words) that
                                supports these sizes.
                               </para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                           <term><literal>filter</literal></term>
                           <listitem>
                               <para>
                                The data are XDR filter data. Note that
                                SpecTcl must have been configured to
                                analyze filter data.
                               </para>
                            </listitem>
                        </varlistentry>
                       </variablelist>
                    </listitem>
                </varlistentry>
            </variablelist>
            <para>
                Note that attaching does not imply starting data analysis.
                That requires using the <literal>/spectcl/start</literal>
                request.
            </para>
            <informalexample>
                <cmdsynopsis><command>
 http://host:port/spectcl/apply/list                   
                </command></cmdsynopsis>
            </informalexample>
            <para>
                The <literal>detail</literal> part of the JSON returned
                is the of the form <literal>SourceType: string</literal>
                where <literal>SourceType:</literal> is either <literal>File</literal>
                or <literal>Pipe</literal> and the string is the data source string,
                that is the filename for <literal>File:</literal> and the
                command on the other end of the <literal>Pipe:</literal>.
            </para>
        </section>
        <section>
            <title>Binding Spectra to Display Memory (new in 5.5)</title>
            <para>
                The <literal>/sbind</literal> domain provides access to the
                <command>sbind</command> SpecTcl command.  This there are three
                subdomains:
            </para>
            <section>
                <title>/sbind/all</title>
                <para>
                    URLs of the form:
                </para>
                <informalexample>
                    <cmdsynopsis><command>
http://host:port:/sbind/all
                    </command></cmdsynopsis>
                </informalexample>
                <para>
                    Bind all spectra to display  memory.  Nothing of value is
                    returned in the  <literal>detail</literal> field of the
                    reply data.
                </para>
            </section>
            <section>
                <title>/sbind/sbind</title>
                <para>
                    URL's of the following form:
                </para>
                <informalexample>
                    <cmdsynopsis><command>
http://host:port/sbind/spectrum?spectrum=name1<optional>&amp;spectrum=name2...</optional>
                    </command></cmdsynopsis>
                </informalexample>
                <para>
                    Bind all spectra named in all instances of the
                    <literal>spectrum</literal> query parameter to display
                    memory. Nothing of use is returned in the
                    <literal>detail</literal> part of the JSON reply data.
                </para>
            </section>
            <section>
                <title>/sbin/list</title>
                <para>
                    URL's of the form:
                </para>
                <informalexample>
                    <cmdsynopsis><command>
http://host:port/sbind/list<optional>?pattern=glob</optional>
                    </command></cmdsynopsis>
                </informalexample>
                <para>
                    Return information about the bindings of spectra that
                    match the <literal>pattern</literal> query parameter interpreted
                    as a glob spectrum name match string.  If omitted the
                    pattern matched defaults to <literal>*</literal>
                    which matches all spectra.
                </para>
                <para>
                    The <literal>detail</literal> attribute of the JSON returned
                    data is an array of objects with the following attributes:
                </para>
                <variablelist>
                    <varlistentry>
                       <term><literal>spectrumid</literal></term>
                       <listitem>
                           <para>
                            The id of the bound spectrum.
                           </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                       <term><literal>name</literal></term>
                       <listitem>
                           <para>
                            The name of the bound spectrum.
                           </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                       <term><literal>binding</literal></term>
                       <listitem>
                           <para>
                            The shared memory binding id.
                           </para>
                        </listitem>
                    </varlistentry>
                </variablelist>
                <para>
                    Note that spectra which are not bound but match the
                    pattern will not appear in the array.
                </para>
            </section>
        </section>
        <section>
            <title>Accessing the fit command (new in 5.5)</title>
            <para>
                The <literal>/spectcl/fit</literal> domain provides
                access to the SpecTcl <command>fit</command> command.
                <command>fit</command> provides you with the ability to
                fit spectra to arbitrary functions.  The built-in
                <literal>linear</literal> and <literal>gaussian</literal>
                fit types are provided and the programming manual describes
                how to extend the set of fits that are provided by this
                command.
            </para>
            <para>
                The URL below:
            </para>
            <informalexample>
                <cmdsynopsis><command>
http://host:port/spectcl/fit/create?name=fitname&amp;spectrum=specname&amp;low=lochan&amp;high=hichan&amp;type=fittype
                </command></cmdsynopsis>
            </informalexample>
            <para>
                Provides the capability to create new fits (<command>fit create</command>).
                The query parameters are as follows:
            </para>
            <variablelist>
                <varlistentry>
                   <term><literal>name</literal></term>
                   <listitem>
                       <para>
                        Name to be associated with the fit.  This will be used
                        when referring to the fit in the future.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>spectrum</literal></term>
                   <listitem>
                       <para>
                        The spectrum on which the fit is to be computed.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>low, high</literal></term>
                   <listitem>
                       <para>
                        The <emphasis>channel</emphasis> coordinates over which
                        the fit is to be computed.  At present, the fit is done
                        in channel coordinates.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>type</literal></term>
                   <listitem>
                       <para>
                        The type of the fit to perform.  The built in fit types
                        are <literal>linear</literal> and <literal>gaussian</literal>
                        which have pretty obvious meanings.  Applications may
                        extend this set of functions.
                       </para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <para>
                The URL
            </para>
            <informalexample>
                <cmdsynopsis><command>
http://host:port/spectcl/fit/update<optional>?pattern=glob</optional>
                </command></cmdsynopsis>
            </informalexample>
            <para>
                Provides the ability to update the set of fits whose names
                match the glob pattern in the query parameter <literal>pattern</literal>.
                As spectra accumulate, fit data will be outdated. This allows
                the fit information to be recomputed to match current data.
            </para>
            <para>
                If the pattern is not provided it defaults to <literal>*</literal>
            </para>
            <para>
                The URL
            </para>
            <informalexample>
                <cmdsynopsis><command>
http://host:port/spectcl/fit/delete?name=fitname                    
                </command></cmdsynopsis>
            </informalexample>
            <para>
                provides the ability to delete the fit object named after the
                contents of the query parameter <literal>name</literal>.  Once
                deleted, the fit cannot be recovered.
            </para>
            <para>
                URLs of the form
            </para>
            <informalexample>
                <cmdsynopsis><command>
http://host:port/spectcl/fit/list?pattern=glob
                </command></cmdsynopsis>
            </informalexample>
            <para>
                Allows you to get information about the fits whose names
                match the <literal>pattern</literal> query parameter.  The
                pattern is treated as a glob pattern and, if not supplied,
                defaults to <literal>*</literal>
            </para>
            <para>
                The result is a <literal>detail</literal> attribute that is an
                array. Each element of the array is an object that
                describes a matching fit. The
                atributes of these objects are:
            </para>
            <variablelist>
                <varlistentry>
                   <term><literal>name</literal></term>
                   <listitem>
                       <para>
                        Name of the fit.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>spectrum</literal></term>
                   <listitem>
                       <para>
                        Name of the spectrum the fit is computed on.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>type</literal></term>
                   <listitem>
                       <para>
                        Type of the fit being computed.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>low, high</literal></term>
                   <listitem>
                       <para>
                        Fit limits in spectrum channel coordinates.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>parameters</literal></term>
                   <listitem>
                       <para>
                        An object that contains the fit parameters.
                        The attributes of this object will depend on the actual
                        fit type.  Likely there will always be a
                        <literal>chisquare</literal> attribute that describes the
                        goodness of fit.
                       </para>
                    </listitem>
                </varlistentry>
            </variablelist>
        </section>
        <section>
            <title>REST interface for the fold command (new in 5.5)</title>
            <para>
                The fold command has three sub opterations that:
            </para>
            <orderedlist>
                <listitem>
                   <para>
                       Fold a list of gamma spectra on a gamma gate.
                   </para>
                </listitem>
                <listitem>
                   <para>
                      Remove a fold from a gamma spectrum .
                   </para>
                </listitem>
                <listitem>
                   <para>
                      List the folded spectra (that match a glob pattern). 
                   </para>
                </listitem>
            </orderedlist>
            <para>
                The URL below applies folds to spectra:
            </para>
            <informalexample>
                <cmdsynopsis><command>
http://host:port/spectcl/fold/apply?gate=gammagate&amp;spectrum=specname1<optional>&amp;spectrum=specname2...</optional>
                </command></cmdsynopsis>
            </informalexample>
            <para>
                The <parameter>gate</parameter> query parameter specifies a gate
                which must be a gamma gate.  One or more <parameter>spectrum</parameter>
                query parameters specify the spectra to be folded with that gate.
            </para>
            <para>
                the <literal>spectcl/fold/apply</literal> URLs do not return
                anything useful other than the status.
            </para>
            <para>
                The URL below lists folded spectra that match the <literal>pattern</literal>
                query parameter (treated as a glob pattern).  If the
                <literal>pattern</literal> query parameter is not supplied, it
                defaults to <literal>*</literal>
            </para>
            <informalexample>
                <cmdsynopsis><command>
http://host:port/spectcl/fold/list<optional>?pattern=globpattern</optional>
                </command></cmdsynopsis>
            </informalexample>
            <para>
                It is important to note that the pattern matches
                <emphasis>spectra</emphasis> not gates.  The <literal>detail</literal>
                part of the return data is an array of JSON objects. Each
                object has the following attributes:
            </para>
            <variablelist>
                <varlistentry>
                   <term><literal>spectrum</literal></term>
                   <listitem>
                       <para>
                        Name of a folded spectrum.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>gate</literal></term>
                   <listitem>
                       <para>
                        Name of the gate used to fold the spectrum.
                       </para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <para>
                Spectra without folds will not be listed in the array.
            </para>
            <para>
                The following URL is used to unfold a spectrum:
            </para>
            <informalexample>
                <cmdsynopsis><command>
http://host:port/spectcl/fold/remove?spectrum=spectrum-name
                </command></cmdsynopsis>
            </informalexample>
            <para>
                The <literal>spectrum</literal> query parameter specifies
                the name of the spectrum from which to remove the fold.
                Nothing useful other than the <literal>status</literal> attribute
                of the reply is returned on success.  
            </para>
        </section>
        <section>
            <title>Accessing the channel command (new in 5.5)</title>
            <para>
                Spectrum channel values can be inspected or set using this interface
                Note that the spectrum contents interface may be a more
                performant method to get bulk spectrum information.
            </para>
            <para>
                URLS of the type below can set the value of a spectrum channel:
            </para>
            <informalexample>
                <cmdsynopsis>
                    <command>
http://host:port/spectcl/channel/set?spectrum=name&amp;xchannel=x&amp;value=value<optional>&amp;ychannel=y</optional>
                    </command>
                </cmdsynopsis>
            </informalexample>
            <para>
                The <literal>spectrum</literal> query parameter specifies
                the name of the spectrum to operate on.
                <literal>xchannel</literal> specifies the x channel number.
                If the spectrum selected is a 2-d spectrum,
                <literal>ychannel</literal> is needed to  specify the y channel.
                Regardless, <literal>value</literal> specifies the value
                to stuff into that spectrum channel.
            </para>
            <para>
                Note that the <emphasis>channel</emphasis> coordinates are
                specified, not real coordinates.
            </para>
            <informalexample>
                <cmdsynopsis><command>
http://host:port/spectcl/channel/get?spectrum=name&amp;xchannel=x<optional>&amp;ychannel=y</optional>
                </command></cmdsynopsis>
            </informalexample>
            <para>
                URLs of the form above, return the value of a channel of a spectrum
                in the <literal>detail</literal> attribute of the reply object.
                The query values <literal>spectrum</literal> and
                <literal>xchannel</literal> specify the spectrum name and
                x channel to fetch. If the spectrum is 2d, an additional
                <literal>ychannel</literal> query parameter is required to
                specify the y channel.
            </para>
            <para>
                Note again, that the <literal>xchannel</literal> and
                <literal>ychannel</literal> coordinates are in spectrum coordinate
                units not real coordinates.
            </para>
        </section>
    </chapter>
</book>
