<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
                      "file:///usr/share/xml/docbook/schema/dtd/4.5/docbookx.dtd
"
>
<book>
    <bookinfo>
      <title>SpecTcl Client Display Interface</title>
      <author><firstname>Ron</firstname><surname>Fox</surname></author>
      <revhistory>
          <revision>
             <revnumber>1.0</revnumber>
             <date>October 27, 2021</date>
             <authorinitials>RF</authorinitials>
             <revremark>Original Release</revremark>
          </revision>
      </revhistory>
    </bookinfo>
    <chapter>
       <title>INTRODUCTION</title>
       <para>
        This document is intended for the following audiences:
       </para>
       <itemizedlist>
        <listitem>
           <para>
              Users of NSCLDAQ that want a persistent SpecTcl to run under
              the NSCLDAQ-12+ experiment manager.
           </para>
        </listitem>
        <listitem>
           <para>
              Users of SpecTcl that want to start up a remote displayer.  This
              includes users of SpecTcl within the NSCLDAQ-12+ experiment manager
              environment.
           </para>
        </listitem>
        <listitem>
           <para>
               Users of SpecTcl that want to remote control a SpecTcl that may
               be running headless in the experiment manager environment.
           </para>
        </listitem>
        <listitem>
           <para>
              Programmers that want to write their own displayers or otherwise
              gain access to the SpecTcl display memory.
           </para>
        </listitem>
        <listitem>
           <para>
              Programmers that need to know the structure of the SpecTcl display
              memory.
           </para>
        </listitem>
       </itemizedlist>
    </chapter>
    <chapter>
       <title>Running SpecTcl Within the NSCLDAQ-12.0+ Experiment Manager.</title>
       <para>
        NSCLDAQ-12.0 introduced an experiment manager. The experiment manager
        allows an experiment to break out of the use of a single account.
        The manager gets started by a user and it  runs programs as needed in the
        background.   The configuration of the programs managed by the program
        manager is defined in an SQLite3 database file.   Editor programs
        allow this database to be modified to describe the programs
        that must be run, and when to run them.  
       </para>
       <para>
        The manager is a server that exports a REST service that supports
        control of the manager.    The manager is, at its heart, a state machine.
        It has a well defined, finite set of states, and well defined transitions
        between those states.   As the manager transitions from one state to the
        next, it runs a set of programs triggered by each transition.  The
        manager is also container aware and programs can be run inside of
        persistent containers that it maintains.
       </para>
       <para>
        You may want to run one or more SpecTcl analysis programs under the control
        of this manager.  If you do that, other chapters in this document
        describe how to run displayers (to visualize the spectra SpecTcl is
        accumulating and the displayable gates), as well as how to control
        these SpecTcl instances with existing graphical user interfaces.
       </para>
       <para>
        SpecTcl, itself, when run under the manager must be run headless.
        This specifically means that:
       </para>
       <itemizedlist>
        <listitem>
           <para>
              You must not allow a histogram visualization program (Displayer)
              to run. 
           </para>
        </listitem>
        <listitem>
           <para>
              <filename>SpecTclRC.tcl</filename>  must not start any graphical
              user interface windows and, in fact, may not require the package
              <literal>Tk</literal>.
           </para>
           <para>
            In order to visualize spectra in systems that are remote from
            SpecTcl, you shouild start the mirror server and REST server.
           </para>
           <para>
            In order to control SpecTcl, you should run its REST server.
           </para>
        </listitem>
       </itemizedlist>
        <para>
            This implies specialized <filename>SpecTclInit.tcl</filename>,
            <filename>SpecTclRC.tcl</filename>.
        </para>
        <para>
            Since program definitions for the experiment manager support
            specifying the working directory of a program, you can, very easily,
            have a separate working directory for interactive SpecTcls and
            managed SpecTcls.  Let's consider, therefore, the following directory
            tree.  <filename>SpecTcl</filename> has the SpecTcl program.
            <filename>SpecTcl/interactive</filename> is the directory from
            which SpecTcl can be run interactively.  It contains the
            normal set of <filename>SpecTclInit.tcl</filename> and
            <filename>SpecTclRC.tcl</filename> scripts you usually use
            to run SpecTcl and has a symbolic link named SpecTcl that points back
            to the executable for SpecTcl.
            Similarly, <filename>SpecTcl/managed</filename>, which we will descrribe
            has <filename>SpecTclRC.tcl</filename> and <filename>SpecTclInit.tcl</filename>
            files as well as its own symbolic link back to the executable.
        </para>
        <para>
            The remainder of this chapter will show example
            <filename>SpecTclInit.tcl</filename> and <filename>SpecTclRC.tcl</filename>
            that will work togethr
            to start SpecTcl under the manager.  We'll also describe how
            to setup SpecTcl within the program manager so that it starts when
            the experiment is booted and stops when it is shutdown.
            This will require two more scripts: <filename>stop.bash</filename> and
            <filename>stop.tcl</filename> in the <filename>SpecTcl/managed</filename>
            directory which we will describe.
        </para>
        <section>
            <title>SpecTclInit.tcl in Managed SpecTcl</title>
            <para>
                SpecTclInit.tcl contains
                variable definitions that SpecTcl examines on
                startup.  These variable definitions control how SpecTcl
                starts up the three definitions we'll need to set properly are:
            </para>
            <variablelist>
                <varlistentry>
                   <term><varname>DisplayType</varname></term>
                   <listitem>
                       <para>
                        This variable determines which of the SpecTcl displayers
                        is started by SpecTcl when it starts.  The value of
                        <literal>none</literal> tells SpecTcl not to start any
                        displayer program.  
                       </para>
                       <para>
                        Note that SpecTcl will still create display shared memory
                        so clients can access the spectra the user has bound
                        into the display memory via <command>sbind</command>.
                        The shared memory region can also be mirrored to remote
                        systems if desired.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><varname>HTTPDPort</varname></term>
                   <listitem>
                       <para>
                        If this variable is defined, SpecTcl will start it's
                        REST server allowing remote control over SpecTcl. With
                        SpecTcl run in the manager, this is the only way to
                        provide a user interface to SpecTcl.  
                       </para>
                       <para>
                        The value of this variable must be in integer.  In the
                        environment of the NSCLDAQ experiment manager, it is
                        recommended that, rather than hard-coding a numerical port,
                        you use the NSCLDAQ port manager to allocate a port and
                        advertise a named service.  We'll describe this process
                        the sample <filename>SpeTclInit.tcl</filename> below.
                       </para>
                       <para>
                        If you do choose to hard code a port number, this value must
                        be unique <emphasis>system wide over all users</emphasis>.
                        If you provide a duplicate port number, you'll wind up starting
                        the REST server on a 'nearby' free port.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><varname>MirrorPort</varname></term>
                   <listitem>
                       <para>
                        If this variable is defined, SpecTcl will start its
                        mirror server.  The mirror server supports remote displayers
                        by providing the ability to create and maintain a mirror of
                        the SpecTcl  display memory on a remote or local system.
                       </para>
                       <para>
                        Under the manager, at FRIB/NSCL, SpecTcl is normally
                        run containerized, and the experiment manager uses persistent
                        containers to accomplis that.   Since persistent containers
                        have their own, private namespace of SYS-V shared memory
                        segments used by SpecTcl for display shared memory,
                        you will need to create a mirror in the local host to
                        allow non-containerized programs or programs in transient
                        containers (<command>singularity shell</command>) to
                        attach displayers to SpecTcl.
                       </para>
                       <para>
                        Mirroring and attached displayers to mirror will be
                        described in the next chapter.
                       </para>
                       <para>
                        As with <varname>HTTPDPort</varname>, this value  should,
                        in most cases be gotten with the NSCLDAQ port manager as
                        it must be a unique integer system wide.
                        </para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <para>
                In the remainder of this section, we will provide a
                sample <filename>SpecTclInit.tcl</filename> file and
                walk through how it works.  In doing so, we will use the port
                manager to get our server ports.  Doing so requires that 
            </para>
            <orderedlist>
                <listitem>
                   <para>
                      The SpecTcl Tcl library directory must be added to the
                      Tcl intepreter package search path.
                   </para>
                </listitem>
                <listitem>
                   <para>
                      The NSCLDAQ-12.0+ environment is set up in the
                      container via its initialization script
                      (e.g. the initialization script source /usr/opt/daq/12.something/daqsetup.bash)
                   </para>
                </listitem>
                <listitem>
                   <para>
                      The value of the environment variable
                      <varname>DAQTCLLIBS</varname> is appended to the
                      Tcl interpreter search path so that the required Port manager
                      interaction  packages can be sourced in.
                   </para>
                </listitem>
            </orderedlist>
            <example>
                <title>Sample SpectclInit.tcl for Experiment Manager</title>
                <programlisting>
lappend auto_path [file join $SpecTclHome TclLibs]   <co id='mgrinit.spectcltcllibs' />
if {[array names env DAQTCLLIBS]  ne ""} {           <co id='mgrinit.daqtcllibs' />
    lappend auto_path $env(DAQTCLLIBS)
}
package require DAQService                          <co id='mgrinit.daqservice' />
set HTTPDPort [SpecTcl::getServicePort SpecTcl_REST]   <co id='mgrinit.restport' />
set MirrorPort [SpecTcl::getServicePort SpecTcl_MIRROR] <co id='mgrinit.mirrorport' />
set DisplayType none                                <co id='mgrinit.nodisplay' />

                </programlisting>
            </example>
            <calloutlist>
                <callout arearefs='mgrinit.spectcltcllibs' >
                    <para>
                        The Tcl variable <varname>SpecTclHome</varname> is defined
                        at SpecTcl's compile and initialization time to be the
                        top level installation directory of SpecTcl.  This
                        line adds the <filename>TclLibs</filename> subdirectory
                        to the Tcl library search path (<varname>auto_path</varname>).
                        The <filename>TclLibs</filename> contains the SpecTcl
                        Tcl library of support packages
                    </para>
                </callout>
                <callout arearefs='mgrinit.daqtcllibs' >
                    <para>
                        This segment of the script determines if the environment
                        variable <varname>DAQTCLLIBS</varname> has been defined and,
                        if so, appends it to the Tcl package  search path.
                        The NSCLDAQ 12.0+ <filename>daqsetup.bash</filename> script
                        defines <varname>DAQTCLLIBS</varname> to point to the
                        NSCLDAQ Tcl package library directory tree.
                    </para>
                    <para>
                        We don't exit if this is not the case as there are
                        other mechanisms to add the DAQ Tcl library packages to
                        the search path (e.g. externally defining
                        <varname>TCLLIBPATH</varname>).
                    </para>
                </callout>
                <callout arearefs='mgrinit.daqservice' >
                    <para>
                        The <literal>DAQService</literal> package is a package
                        in the SpecTcl Tcl package library that provides a simplified
                        interface to the NSCLDAQ Port manager for advertising
                        services and obtaining the port allocated.  Note that since
                        this depends on the low-level NSCLDAQ port manager package,
                        we needed, as we did previously, add the NSCLDAQ Tcl library
                        packages to the Tcl interpreter package search paths.
                    </para>
                </callout>
                <callout arearefs='mgrinit.restport' >
                    <para>
                        The <literal>DAQService</literal> package exports the
                        <command>SpecTcl::getServicePort</command> proc.
                        This proc takes a service name as a parameter and returns
                        the port that has been allocated to that service by
                        the port manager.  Service names shouild be unique
                        with <emphasis>users</emphasis> requesting them.
                    </para>
                    <para>
                        This line advertises the service <literal>SpecTcl_REST</literal>
                        and assigns the resulting port to <varname>HTTPPort</varname>.
                        The service can be looked up by clients and the resulting
                        port then used to connect to the REST server that
                        SpecTcl will start listening for connections on that port/
                    </para>
                </callout>
                <callout arearefs='mgrinit.mirrorport' >
                    <para>
                        Similarly, the service <literal>SpecTcl_MIRROR</literal>
                        is advertised and the resulting port set to the
                        <varname>MirrorPort</varname> so that when SpecTcl
                        starts its mirror service it will be listening on the
                        corresponding port.
                    </para>
                </callout>
                <callout arearefs='mgrinit.nodisplay' >
                    <para>
                        Setting the <varname>DisplayType</varname> to
                        <literal>none</literal> means that SpecTcl will not
                        start a spectrum display program but it will, nonetheless,
                        create the spectrum shared memory so that local clients
                        can display data from it and remote clients, upon setting up
                        a mirror, can also display data from it.
                    </para>
                </callout>
            </calloutlist>
        </section>
        <section>
           <title>SpecTclRC.tcl for Managed SpecTcl</title>
           <para>
            <filename>SpecTclRC.tcl</filename> should be very minimal.
            This is because in most cases, users use <filename>SpecTclRC.tcl</filename>
            to create graphical user interfaces (GUIs) which managed SpecTcl's
            cannot display.  A later chapter will describe how to run
            these as clients of the SpecTcl REST server.
           </para>
           <para>
            We recommend using SpecTclRC.tcl to:
           </para>
           <itemizedlist>
            <listitem>
               <para>
                  Read in a SpecTcl configuration file, and bind its spectra into
                  the SpecTcl shared memory region.
               </para>
            </listitem>
            <listitem>
               <para>
                  Read in any non-interactive scripts your GUI's might use
                  that would run better locally than remotely (see, however
                  the chapter on running scripts remotely).
               </para>
            </listitem>
            
           </itemizedlist>
           <example>
            <title>
                Sample SpecTclRC.tcl Script for Managed SpecTcl.
            </title>
            <programlisting>
source mydefinitions.tcl     <co id='managed.rcdefs' />
sbind -all                   <co id='managed.rcsbind' />
source mylocalprocs.tcl      <co id='managed.rclocalprocs' />

set pidfile [open spectclpid w]
puts $pidfile [pid]          <co id='managed.rcpid' />
close $pidfile

            </programlisting>
           </example>
           <calloutlist>
            <callout arearefs='managed.rcdefs' >
                <para>
                    Reads in a SpecTcl definition file that contains tree parameter
                    definitions, spectrum definitions, gate definitions and
                    applications as well as tree variable values.
                </para>
            </callout>
            <callout arearefs='managed.rcsbind' >
                <para>
                    Binds all the spectra defined in <filename>mydefinitions.tcl</filename>
                    to the display shared memory.  This makes them visible
                    to local displayers attached to SpecTcl as well as remote
                    displayers when mirroring has been started to the remote
                    system.
                </para>
            </callout>
            <callout arearefs='managed.rclocalprocs' >
                <para>
                    Sources in any Tcl procedures you want SpecTcl to hold locally.
                    These may be procs that are invoked by SpecTcl's compiled
                    code or utilities that your GUI scripts use that will run
                    better or faster locally rather than remotely.
                </para>
                <para>
                    It's perfectly normal and acceptable for a line like this
                    to be omitted.
                </para>
            </callout>
            <callout arearefs='managed.rcpid' >
                <para>
                    Records the process id of SpecTcl in the file
                    <filename>spectclid</filename>.  This allows us to
                    define a command in the manager to kill SpecTcl when the
                    system is shutting down.
                </para>
            </callout>
           </calloutlist>
        </section>
        <section>
           <title>Defining SpecTcl to the Manager.</title>
           <para>
            Using SpecTcl with the NSCLDAQ experiment manager means defining it as
            a program as well as defining a program to stop it.  It then means
            attaching the start program to the <literal>BOOT</literal>
            state transition and attaching the stop program to the
            <literal>SHUTDOWN</literal> transition.
           </para>
           <para>
            Throughout this section, we will assume that
            <filename>SpecTclRC.tcl</filename> will create a file named
            spectclpid in its working directory that will contain its process ID.
           </para>
        </section>
        <section>
            <title>Starting SpecTcl in the Manager</title>
            <para>
                Use the <filename>$DAQBIN/mg_config</filename> progream specifying as
                a parameter the name of the manager's configuration database file.
                When the list of configuration options pops up, double click on
                <literal>Programs</literal> to define the SpecTcl program.
            </para>
            <para>
                When the list of defined programs pops up, click the
                <guibutton>New...</guibutton> button to bring up the program editor.
                Fill in the following fields in the editor as follows::
            </para>
            <variablelist>
                <varlistentry>
                   <term><literal>Name:</literal></term>
                   <listitem>
                       <para>
                        A unique program name such as <literal>SpecTcl</literal>
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>Host</literal></term>
                   <listitem>
                       <para>
                        DNS name of the computer on which you want SpecTcl to run.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>Working Directory</literal></term>
                   <listitem>
                       <para>
                        The <filename>SpecTcl/managed</filename> director in which
                        you put your <filename>SpecTclInit.tcl</filename> and
                        <filename>SpecTclRC.tcl</filename> scripts for managed
                        Spectcl.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>Program File:</literal></term>
                   <listitem>
                       <para>
                        The path to the SpecTcl you want to run.  This
                        can be releative.  If you created the symlink to
                        the SpecTcl executable you want to run this can be e.g.
                        <literal>./SpecTcl</literal>
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>Container</literal></term>
                   <listitem>
                       <para>
                        If you want SpecTcl to run in a container, this should be
                        the name of a container that you defined earlier.
                        If left blank, SpecTcl will run in native mode.
                        The container should have a startup script that
                        sources in the NSCLDAQ Environment definition script,
                        see, however, below.
                       </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                   <term><literal>Type:</literal></term>
                   <listitem>
                       <para>
                        Select the <literal>Persistent</literal> radio button
                        to indicate that SpecTcl is expected to persist but
                        that the data flow can continue if it exits.
                       </para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <para>
                If your container or other environment do not define
                DAQTCLLIBS as expected by the <filename>SpecTclInit.tcl</filename>
                script we created, you can use the
                <literal>Program Environment</literal> editor section to set this
                or, alternatively <literal>TCLLIBPATH</literal>.
            </para>
            <para>
                Click <guibutton>Ok</guibutton> to save the definition and close
                the program list.
            </para>
            <para>
                Having create the program you need to add it to a sequence triggered
                by Boot.
                Double click the <literal>Sequence Definition</literal> entry in
                the top level window.  If there is no sequence triggered by
                booting the system, type <literal>BOOT</literal> in the
                <literal>New sequence:</literal> entry.  Pull down the
                <literal>Trigger state:</literal> drop down menu and select
                <literal>BOOT</literal> then click <guibutton>Add</guibutton>
                to add the sequence.
            </para>
            <para>
                Double click <literal>BOOT</literal> from the list of sequences
                to pop up the sequence editor.  In the <literal>Program name</literal>
                pulldown, select <literal>SpecTcl</literal> (or the name you gave
                to your SpecTcl program definition.  Click <guibutton>Add</guibutton>
                to add this to the <literal>BOOT</literal> sequence and
                click <guibutton>SAVE</guibutton> to save the modified sequence.
            </para>
            <para>
                You also need to kill SpecTcl when the experiment is <literal>Shutdown</literal>.
                Define a program with the same attributes as your SpecTcl program
                however:
            </para>
            <itemizedlist>
                <listitem>
                   <para>
                      Select a <literal>Transitory</literal>  program type.
                   </para>
                </listitem>
                <listitem>
                   <para>
                      For the <literal>Program File:</literal> enter:
                      <literal>kill -9 `cat spectclpid`</literal>
                   </para>
                </listitem>
            </itemizedlist>
            <para>
                Add this to a sequence that's triggerd by the <literal>SHUTDOWN</literal>
                transition.  Since the programs run as shell commands this works to
                send a <literal>SIGKILL</literal> signal to the program whose
                PID is stored in the <filename>spectclpid</filename> file the
                SpecTcl <filename>SpecTclInit.tcl</filename> sample file wrote
                when SpecTcl started.
            </para>
        </section>
    </chapter>
    <chapter>
       <title>Starting a Remote Displayer With xaminerunner</title>
       <para>
       </para>
    </chapter>
    <chapter>
       <title>Running Spectcl Scripts Remotely Via the REST Server</title>
       <para>
       </para>
    </chapter>
    <chapter>
       <title>Using the Mirror API to Access SpecTcl Shared Display Memory.</title>
       <para>
       </para>
    </chapter>
    <chapter>
       <title>Structure Of the SpecTcl Shared Display Memory</title>
       <para>
       </para>
    </chapter>
    <appendix>
        <title>New SpecTclInit.tcl features.</title>
        <variablelist>
            <varlistentry>
               <term><varname>HTTPDPort</varname></term>
               <listitem>
                   <para>
                    This variable can be set in SpecTcl 5.0 and later. If it is
                    defined in SpecTclInit.tcl, it must be an integer value.
                    SpecTcl will then start an HTTPD/REST server listening on the
                    port number that is the value of that variable.
                   </para>
                   <para>
                    Non privileged users of SpecTcl must select a value
                    larger than <literal>1023</literal>.  If the specified
                    port is already being used, SpecTcl will search for a nearby
                    port to use.  The port number actually selected will be
                    output in the SpecTcl startup messages.
                   </para>
                   <para>
                    As described later it is also possible, in the NSCLDAQ
                    environment, to get the NSCLDAQ port manager to allocate
                    a port number and advertise a service that can be translated
                    by client software.
                   </para>
                </listitem>
            </varlistentry>
            <varlistentry>
               <term><varname>MirrorPort</varname></term>
               <listitem>
                   <para>
                    This variable can be set in SpecTcl 5.10 and later.  If it
                    is defined in SpecTclInit.tcl, it must be an integer value
                    greater than <literal>1023</literal>.   If defined, the
                    value is used as the listener port for the display memory
                    mirror server.  
                   </para>
                   <para>
                    The display memory mirror server supports clients creating
                    memory regions that are mirrors of the SpecTcl display shared
                    memory.
                   </para>
                </listitem>
            </varlistentry>
        </variablelist>
        <para>
            Both of the new variables support describing a listen port for a server.
            The NSCLDAQ running system provides a mechanism for allocating such ports
            from a large pool of reserved ports.  Allocated ports are associated
            with a name and user that can be resolved by clients in systems
            that have NSCLDAQ installed (but not necessarily running).
        </para>
        <para>
            A simplified allocation interface is included in SpecTcl-5.10+ as long
            as the NSCLDAQ environment variables for NSCLDAQ-12.0+ are set up.
        </para>
        <para>
            The example below is a fragment from a <filename>SpecTclInit.tcl</filename>
            script that uses this capability to assign and advertise ports
            for the REST and Mirror servers:
        </para>
        <example>
            <title>Advertising REST and Mirror Ports With the NSCLDAQ PortManager</title>
            <programlisting>
lappend auto_path [file join $SpecTclHome TclLibs]
if {[array names env DAQTCLLIBS]  ne ""} {         <co id='portman.tcllibs' />
    lappend auto_path $env(DAQTCLLIBS)
}
package require DAQService                         <co id='portman.package' />
set HTTPDPort [SpecTcl::getServicePort SpecTcl_REST] <co id='portman.advertise' />
set MirrorPort [SpecTcl::getServicePort SpecTcl_MIRROR]

            </programlisting>
        </example>
        <calloutlist>
            <callout arearefs='portman.tcllibs' >
                <para>
                    Starting with NSCLDAQ-12.0, the <filename>daqsetup.bash</filename>
                    script exports the environment variable <literal>DAQTCLLIBS</literal>.
                    This sectio of code tests for the existence of that variable and,
                    if defined, adds its value to the Tcl library package search
                    path.  If you are using a version earlier than NSCLDAQ-12.0,
                    you must either define <literal>TCLLIBPATH</literal> to point
                    to the <literal>$DAQROOT/TclLibs</literal>, or manually add
                    that directory to the <varname>auto_path</varname>.
                </para>
            </callout>
            <callout arearefs='portman.package' >
                <para>
                    The <literal>DAQService</literal> package provides a simplified
                    interface to the NSCLDAQ port manager.  It does, however
                    require the ability to load the NSCLDAQ packages that
                    interface with that port manager, hence the code to
                    extend the <varname>auto_path</varname> variable previously
                    described.
                </para>
            </callout>
            <callout arearefs='portman.advertise' >
                <para>
                    The <literal>SpecTcl::getServicePort</literal> proc
                    takes, as an argument, the name of a service you wish to
                    advertise.  It returns the port number allocated to that
                    service.  This is used to set the values of both
                    <varname>HTTPDPort</varname> and <varname>MirrorPort</varname>
                </para>
            </callout>
        </calloutlist>
    </appendix>
</book>